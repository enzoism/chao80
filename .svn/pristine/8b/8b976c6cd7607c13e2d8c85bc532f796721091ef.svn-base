<!DOCTYPE html>
<html>
	<head>
    	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">  
		<title>添加News</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="format-detection" content="telephone=no">
		<link rel="stylesheet" href="/admin/plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="/admin/plugins/font-awesome/css/font-awesome.min.css">
  		<link rel="stylesheet" href="/admin/plugins/layui2/css/layui.css"  media="all">
		<script src="/admin/plugins/layui2/layui.js" charset="utf-8"></script>
		<script type="text/javascript" src="/admin/js/jquery.js"></script>
		<style type="text/css">
			#sort{overflow:hidden;}
			#sort .WY_img{width:400px;height:240px;border:2px #ddd solid;float:left;margin-right:20px;position:relative;}
			#sort .WY_img img{max-width:400px;max-height:240px;}
			#sort .WY_img i{position:absolute;right:5px;top:5px;}
		</style>
	</head>

	<body>
		<div style="margin: 15px;">
			<blockquote class="layui-elem-quote">
				<button class="layui-btn" id="backBtn"><i class="layui-icon">返回</i></button>
				<button class="layui-btn" id="refresh"><i class="layui-icon">刷新</i></button>
			</blockquote>
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>添加Video信息</legend>
			</fieldset>

			<form class="layui-form" action="/jsonAction/release_addVideoMsg.action" method="post" id="uploadForm">
				<input type="text" name="imageURL" lay-verify="required" autocomplete="off" class="layui-input" id="imageURL" style="display: none;">
				<div class="layui-form-item">
					<label class="layui-form-label">标题</label>
					<div class="layui-input-block">
						<input type="text" name="relTitle" lay-verify="required|relTitle" placeholder="100字以内..." autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">子标题</label>
					<div class="layui-input-block">
						<input type="text" name="relSubTitle" lay-verify="required|relSubTitle" placeholder="100字以内..." autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">详细介绍</label>
					<div class="layui-input-block">
						<textarea placeholder="请输入内容" name="relBrief" class="layui-textarea"></textarea>
					</div>
				</div>
				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">远程链接</label>
					<div class="layui-input-block">
        				<input type="tel" name="videoURL" lay-verify="required|url" autocomplete="off" class="layui-input" id="videoURL">
					</div>
				</div>
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>上传video视频</legend>
			</fieldset>
			<div class="layui-form-item layui-form-text">
				<div class="layui-form-item">
					<table class="layui-table">
						<thead>
							<tr>
								<th>文件名</th>
								<th>大小</th>
								<th>状态</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody id="videoList"></tbody>
					</table>
				</div>
				<button type="button" class="layui-btn layui-btn-normal" id="videoChoseBTN">选择视频文件</button>
				<button type="button" class="layui-btn" id="videoSubBTN">开始上传</button>
			</div>
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>上传Video缩略图</legend>
			</fieldset>
			<div class="layui-form-item layui-form-text">
				<div class="layui-form-item">
					<table class="layui-table">
						<thead>
							<tr>
								<th>文件名</th>
								<th>大小</th>
								<th>状态</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody id="imageList"></tbody>
					</table>
				</div>
				<button type="button" class="layui-btn layui-btn-normal" id="imageChoseBTN">选择图片文件</button>
				<button type="button" class="layui-btn" id="imageSubBTN">开始上传</button>
			</div>
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>图片预览</legend>
			</fieldset>
			<div class="layui-form-item" id="sort"></div>
			
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>上传video信息</legend>
			</fieldset>
			<div class="layui-form-item">
				<button type="reset" class="layui-btn layui-btn-primary" id="resetForm">重置</button>
				<button class="layui-btn" lay-submit lay-filter="*">立即提交</button>
			</div>
			</form>
		</div>
		<script src="/admin/js/sortable.js" charset="utf-8"></script>
		<script type="text/javascript">
			// 移动删除图片
			function remove_img(e){
				$(e).parent().remove();
				resort_img();
			}
			function resort_img(){
				var arr=[];
				$('#sort .WY_img').each(function(i,v){
					var src=$(v).attr('data');
					if(src){
						arr.push(src);
					}
				});
				$("#imageURL").val(arr.join(','));
				if(arr.length ==0){
					$("#imageChoseBTN").show();
				}else{
					$("#imageChoseBTN").hide();
				}
			}			
			// form渲染
			layui.use(['form', 'upload', 'laydate', 'layedit'], function() {
				var $ = layui.jquery,
					form = layui.form,
					layer = layui.layer,
					upload = layui.upload,
					laydate = layui.laydate,
					layedit = layui.layedit,
					videoFiles,imageFiles;
				//编辑器:创建
				layedit.build('collectionEditor');
				
				// 按钮事件
				$('#backBtn').on('click', function() {
					window.history.go(-1);
				});
				$('#refresh').on('click', function() {
					location.reload();
				});

				// 监控form提交
				form.on('submit(*)', function(data){
					uploadFormData();
					return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
				});
	 
				//多文件列表示例
				var videoListView = $('#videoList'),
					videoListIns = upload.render({
						elem : '#videoChoseBTN',
						url : '/jsonAction/upload_uploadVideo.action',
						accept : 'video',
						multiple : false,
						auto : false,
						bindAction : '#videoSubBTN',
						choose : function(obj) {
							console.log("-----视频选取");
							videoFiles = obj.pushFile(); //将每次选择的文件追加到文件队列
							//读取本地文件
							obj.preview(function(index, file, result) {
								var tr = $([ '<tr id="upload-' + index + '">'
									, '<td>' + file.name + '</td>'
									, '<td>' + (file.size / 1024).toFixed(1) + 'kb</td>'
									, '<td>等待上传</td>'
									, '<td>'
									, '<button class="layui-btn layui-btn-mini demo-reload layui-hide">重传</button>'
									, '<button class="layui-btn layui-btn-mini layui-btn-danger demo-delete">删除</button>'
									, '</td>'
									, '</tr>' ].join(''));
								$("#videoChoseBTN").hide();
								//单个重传
								tr.find('.demo-reload').on('click', function() {
									obj.upload(index, file);
									return false;
								});
								//删除
								tr.find('.demo-delete').on('click', function() {
									delete videoFiles[index]; //删除对应的文件
									tr.remove();
									$("#videoURL").val(null);
									$("#videoChoseBTN").show();
								});
								videoListView.append(tr);
								$("#videoChoseBTN").hide();
							});
						},
						done : function(res, index, upload) {
							if (res.statusCode == 200) { //上传成功
								var tr = videoListView.find('tr#upload-' + index),
									tds = tr.children();
								tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
								tds.eq(3).html(''); //清空操作
								var d=$("#videoURL").val();
								if(d){
									d=d.split(',');
								}else{
									d=[];
								}
								d.push(res.src);
								$("#videoURL").val(d.join(','));
								delete videoFiles[index]; //删除文件队列已经上传成功的文件
								$("#videoChoseBTN").hide();
								return;
							}
							this.error(index, upload);
						},
						error : function(index, upload) {
							var tr = videoListView.find('tr#upload-' + index),
							tds = tr.children();
							tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
							tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
							// 清空数据
							$("#videoURL").val(null);
						}
					});
				//图片列表示例
				var imageListView = $('#imageList'),
					imageListIns = upload.render({
						elem : '#imageChoseBTN',
						url : '/jsonAction/upload_uploadImages.action',
						multiple : false,
						auto : false,
						bindAction : '#imageSubBTN',
						choose : function(obj) {
							console.log("-----图片选取");
							imageFiles = obj.pushFile(); //将每次选择的文件追加到文件队列
							//读取本地文件
							obj.preview(function(index, file, result) {
								var tr = $([ '<tr id="upload-' + index + '">'
									, '<td>' + file.name + '</td>'
									, '<td>' + (file.size / 1024).toFixed(1) + 'kb</td>'
									, '<td>等待上传</td>'
									, '<td>'
									, '<button class="layui-btn layui-btn-mini demo-reload layui-hide">重传</button>'
									, '<button class="layui-btn layui-btn-mini layui-btn-danger demo-delete">删除</button>'
									, '</td>'
									, '</tr>' ].join(''));
								$("#imageChoseBTN").hide();
								//单个重传
								tr.find('.demo-reload').on('click', function() {
									obj.upload(index, file);
									$("#imageChoseBTN").hide();
									return false;
								});
								//删除
								tr.find('.demo-delete').on('click', function() {
									delete imageFiles[index]; //删除对应的文件
									tr.remove();
									$("#imageChoseBTN").show();
								});
								imageListView.append(tr);
								$("#imageChoseBTN").hide();
							});
						},
						done : function(res, index, upload) {
							if (res.statusCode == 200) { //上传成功
								var tr = imageListView.find('tr#upload-' + index),
									tds = tr.children();
								tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
								tds.eq(3).html(''); //清空操作
								$("#imageURL").val(res.src);
								var d=$("#imageURL").val();
								if(d){
									d=d.split(',');
								}else{
									d=[];
								}
								d.push(res.src);
								tr.attr({'data':res.src});
								var h='<div class="WY_img" data="'+res.src+'"><img src="/upload'+res.src+'"/> <i class="layui-btn layui-btn-small layui-btn-normal" onclick="remove_img(this)">删除</i></div>';
								$('#sort').append(h);
								delete imageFiles[index]; //删除文件队列已经上传成功的文件
								resort_img();
								return;
							}
							this.error(index, upload);
						},
						error : function(index, upload) {
							var tr = imageListView.find('tr#upload-' + index),
							tds = tr.children();
							tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
							tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
						}
					});
			});
			
			// 提交表单
			function uploadFormData(){
				resort_img();
				$.ajax({
	                cache: true,
	                type: "POST",
	                url:'/jsonAction/release_addVideoMsg.action?v=' + new Date().getTime(),
	                data:$('#uploadForm').serialize(),// 你的formid
	                async: false,
	                error: function(request) {
	                	layer.msg("Video发布失败");
	                },
	                success: function(data) {
						layer.confirm('Video发布成功，是否继续上传?', { icon: 1, title: '系统提示' }, function (index) {
							layer.close(index);
							location.reload(); //刷新
			            });
	                }
	            });
			}
		</script>
		
	</body>

</html>