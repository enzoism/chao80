/**
 * Created by wenbin.lu on 2017/10/12.
 */
Chao.collectors = {
    type:1,
    init: function () {
        var that=this,id=Chao.util.getSearch('id');
        this.userSequence=id;
        $.ajax({
            url:Chao.APP.DATA+'release_queryReleasedCategaryList.action',
            data:{userSequence:id},
            beforeSend:function(){},
            success:function(r){
                if(r.statusCode=="200"){
                    var i=0,d=r.categaryList,len=d.length,h=[],className;
                    for(i;i<len;i++){
                        if(i==2){
                            className=' ml120'
                        }else{
                            className='';
                        }
                        h.push('<div data_cateSequence="'+d[i].cateSequence+'" class="category_name '+className+'"><span>'+d[i].cateName+'</span><i>'+d[i].colCount+'</i></div>');
                    }
                    $('#categorys').html(h.join(''));
                    $('#categorys div').eq(0).addClass('cur');
                    that.loadData(d[0].cateSequence);
                    $('#categorys div').click(function(){
                        $(this).siblings().removeClass('cur').end().addClass('cur');
                        that.loadData($(this).attr('data_cateSequence'));
                    });
                    i=0;
                    h=[];
                    for(i;i<60;i++){
                        h.push('<div><span class="plus lt"></span><span class="plus rt"></span><span class="plus lb"></span><span class="plus rb"></span><div class="img"></div></div>');
                    }
                    $('#content').html(h.join(''));
                    i=0;
                    var u=r.userMsg;
                    h=[];
                    h.push('<div class="user_info"><img src="'+u.userImageURL+'" alt=""/></div>');
                    h.push('<div class="name">'+u.userName+'</div>');
                    h.push('<div class="summary">粉丝 <span class="fans">'+u.fansCount+'</span>|关注 <span class="focus">'+u.attentCount+'</span>| 赞 <span class="fave">'+u.likedCount+'</span></div>');
                    if(u.hasAttention && u.hasAttention!="false"){
                        h.push('<a class="focus_btn cur" onclick="Chao.collectors.fave_remove(this)"  title="取消关注" data_userSequence="'+u.userSequence+'">已关注</a>');
                    }else{
                        h.push('<a class="focus_btn" onclick="Chao.collectors.fave_add(this)" title="点击关注" data_userSequence="'+u.userSequence+'">关注</a>');
                    }
                    $('#user_info').html(h.join(''));

                }
            },
            error:function(){}
        });
        $('#content_warp').mousewheel(function (event,delta) {
            if(delta>0){
                //up
                if(that.type==1){
                    that.type++;
                    that.m();
                }else if(that.type==2){
                    that.type++;
                    that.l();
                }else if(that.type==3){
                    // that.next();
                }
            }else if(delta<0){
                //down
                if(that.type==3){
                    that.type--;
                    that.m();
                }else if(that.type==2){
                    that.type--;
                    that.s();
                }else{
                    that.type=1;
                }
            }
            event.stopPropagation();
            event.preventDefault();
        });

        this.buildline();
        $(window).resize(function () {
            that.buildline();
        });
    },
    fave_add:function (e) {
        //关注用户
        var userSequence=$(e).attr('data_userSequence');
        $.ajax({
            url:Chao.APP.DATA+'attention_addUserAttention.action',
            data:{userSequence:userSequence},
            beforeSend:function(){},
            success:function(r){
                if(r.statusCode=="200"){
                    $(e).html('已关注').attr({"onclick":"Chao.collectors.fave_remove(this)","title":"取消关注"});
                    var o=$(e).parent().find('.fans');
                    var n=parseInt(o.html());
                    o.html(n+1);
                }
            },
            error:function(){}
        });
    },
    fave_remove:function (e) {
        // 取消关注用户
        var userSequence=$(e).attr('data_userSequence');
        $.ajax({
            url:Chao.APP.DATA+'attention_removeUserAttention.action',
            data:{userSequence:userSequence},
            beforeSend:function(){},
            success:function(r){
                if(r.statusCode=="200"){
                    $(e).html('关注').attr({"onclick":"Chao.collectors.fave_add(this)","title":"点击关注"});
                    var o=$(e).parent().find('.fans');
                    var n=parseInt(o.html());
                    n=n-1>0?(n-1):0;
                    o.html(n);
                }
            },
            error:function(){}
        });
    },
    _D:[],
    loadData:function(id){
        var that=this;
        $.ajax({
            url:Chao.APP.DATA+'release_queryReleasedDataList.action',
            data:{userSequence:this.userSequence,cateSequence:id,pageNo:1,pageSize:200},
            beforeSend:function(){},
            success:function(r){
                that._D=[];
                if(r.statusCode=="200"){
                    that._D=r.categaryList;
                    that.s();
                }
            },
            error:function(){}
        });
    },
    buildline:function(){
        var w=$(document).width(),
            ml=(w-1200)/2,
            h=$(document).height();
        $('.w').css({'width':w,"margin-left":-ml});
        $('.h').css({'height':h});
    },
    page:0,
    setPage:function(i){
        this.page=i;
        this.buildPage();
        this.buildContent();
    },
    buildPage:function(){
        var k=this.type==1?60:15,i=0,len=Math.ceil(this._D.length/k),h=[];
        for(i;i<len;i++){
            if(i==this.page){
                h.push('<span>'+(i+1)+'</span>');
            }else{
                h.push('<a onclick="Chao.collectors.setPage('+i+')">'+(i+1)+'</a>');
            }
        }
        $('#page').html(h.join(''));
    },
    buildContent:function(){
        var k=this.type==1?60:15,i=this.page,h=[],D=this._D,len=D.length,max=Math.ceil(len/k),j=0;
        i=i*k;
        len=(i+k)>len?len:(i+k);
        // $('#content img').hide();
        for(i;i<len;i++){
            $('#content .img').eq(j).html('<img src="'+D[i].colThumb+'" />');
            j++;
        }
        for(j;j<60;j++){
            $('#content .img').eq(j).html('');
        }
    },
    s:function () {
        document.getElementById('content_warp').className='content s';
        document.getElementById('content').className='s';
        this.page=0;
        this.type=1;
        $('#page').show();
        $('#detail').hide();
        this.buildPage();
        this.buildContent();
    },
    m:function () {
        document.getElementById('content_warp').className='content m';
        document.getElementById('content').className='m';
        $('#detail').hide();
        $('#page').show();
        this.page=0;
        this.buildPage();
        this.buildContent();
    },
    l:function () {
        $('#page').hide();
        var len=this._D.length, prev, first, next;
        if(len==0){
            prev="";
            first="";
            next="";
        }else if(len==1){
            prev=this._D[0].colThumb;
            first=this._D[0].colThumb;
            next=this._D[0].colThumb;
        }else{
            prev=this._D[len-1].colThumb;
            first=this._D[0].colThumb;
            next=this._D[1].colThumb;
        }
        $('.prev_img').html('<img src="'+prev+'"/>');
        $('.show_img').html('<img src="'+first+'" />');
        $('.next_img').html('<img src="'+next+'" />');
        document.getElementById('content').className='m l';
        $('#detail').fadeIn();
    },
    link:false,
    preview_index:0,
    next:function () {
        if(this.lock){
            return false;
        }
        this.lock=true;
        var that=this;
        var x=$('.prev_img').clone(),y=$('.show_img').clone();
        $('#detail').append(x);
        //设置上一张
        var len=this._D.length, prev;
        if(len==0){
            prev="";
        }else if(len==1){
            prev=this._D[0].colThumb;
        }else{
            this.preview_index++;
            if(this.preview_index==len){
                this.preview_index=0;
            }
            prev=this._D[this.preview_index-1].colThumb;
        }
        $('.prev_img').eq(0).html('<img src="'+prev+'"/>');
        $('.show_img').eq(0).children('img').hide();
        $('#detail').append(y);
        x.animate({
            width: 719,
            top: 1,
            left: 241,
            height: 388
        },500,function () {
            $('.show_img').eq(0).html(x.html());
            $('#view_btn').attr({"href":"detail.html?id="+that._D[that.preview_index].colSequence});
            x.remove();
            that.lock=false;
        });
        y.animate({
            width: 240,
            top: 130,
            left: 960,
            height: 130
        },500,function () {
            y.remove();
            $('.next_img').eq(0).html(y.html());
            that.lock=false;
        });
    },
    prev:function () {
        if(this.lock){
            return false;
        }
        this.lock=true;
        var that=this;
        var x=$('.next_img').clone(),y=$('.show_img').clone();
        $('#detail').append(x);
        //设置下一张
        var len=this._D.length, next;
        if(len==0){
            next="";
        }else if(len==1){
            next=this._D[0].colThumb;
        }else{
            var k=this.preview_index+2;
            if(k>(len-1)){
                k=1;
            }else if(k==(len-1)){
                k=0;
            }
            this.preview_index--;
            if(this.preview_index<0){
                this.preview_index=len-1;
            }
            next=this._D[k].colThumb;
        }
        $('.next_img').eq(0).html('<img src="'+next+'"/>');//跟换下一张
        $('.show_img').eq(0).children('img').hide();
        x.animate({
            width: 719,
            top: 1,
            left: 241,
            height: 388
        },500,function () {
            $('.show_img').eq(0).html(x.html());
            $('#view_btn').attr({"href":"detail.html?id="+that._D[that.preview_index].colSequence});
            x.remove();
            that.lock=false;
        });
        $('#detail').append(y);
        y.animate({
            width: 240,
            top: 130,
            left: 0,
            height: 130
        },500,function () {
            y.remove();
            $('.prev_img').eq(0).html(y.html());
            that.lock=false;
        });
    }
};
Chao.collectors.init();

